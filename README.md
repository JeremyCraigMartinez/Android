1. Introduction
1.1 Background


The Intelligent Remote DiAbetes Health Coach is a smart phone app for android. It allows a person to monitor their activity level and record food intake. This app is designed primarily for researchers to collect physical activity data and food intake from individuals who are part of a research study group. It utilizes the latest Restful Services technology to captured and transmit sensor data over a secured HTTPS connection. IReach app uses the sensors in the phone to gather activity data based on the type of activity that is performed and the duration of said activity. The data captured is sent to the server for analysis as to what type of activity (e.g. Running, Walking, Joging…). Physicians and researchers can then use this data to provide quality care to their patients/subjects.


What's New:

The Android App Store contains many variations of similar apps that count the number of steps that a person walks/ jogs and estimate the caloric expenditure. What sets IReach apart from all others is its ability to classify  the activity type a person is performing by comparing the sensor output to the machine learning algorithm that we have implemented. 


Environment:

Ireach is designed to run on the smart phone and capture and transmit sensor data. Ireach currently supports android's lollipop operating system with but it also has backwards compatibility to support devices as old as android 4.4 KitKat. The User Interface (UI) is written purely in C# using Xamarin.Android Framework which uses Microsoft's latest .Net technology enhancing the overall user experience and performance. 


1.2 Design Goals


Android App:

The design of the app consists of the following. A graphical user interface (GUI) used to visualize data entered by user or generated by the activity detector. The GUI is also important in providing feedback to the user based on the data. Due to the sensitive nature of the data that is collected and to protected users confidentiality we have implemented a secure authentication using Email and password. All users of iReach will be required to login prior to accessing app data. Personal Data that is saved on the web database is only accessible to the users physician and or the authorized research coordinators of the particular group that the user belongs to.

Local data storage 
		
Storing data locally is an essential part of every app, it reduces the amount of network data required to access data remotely and the cost associated with using wireless data plans. Ireach uses SQLite local database to store user profile information and Phone Sensor Data. The database uses Object Relational Mapping or ORM to create tables with associated values. Once a Wifi connection is established the app handles the transmission of data to the server. As of version 1.0 the app is only able to transmit the data to server for analysis. Once the data is analyzed, physicians and researchers.

Backend Restful API services.

See API Section.


Application Design Pattern:

A good software design separates code from implementation. In order to achieve good software design and 
to adhere to the android design spec. we designed Ireach app using the Model-View-View-Model to achieve code 
separation. In this design pattern originally developed by Microsoft (see MVC), we implement all the android UI specific controls (Views) in a separate Xamarin.Android program, and the business and logic layer of the app (ViewModels) is implemented in the portable Class Libraries (PCL). 


 diagram mvvm
credits Reynolds Mark Xamarin Essentials 

Ireach.Core (Portable Library)

Contains logic which connects the Views (UI platform specific) to their associated ViewModels. Using this approach we can define a ViewModel (e.g. LoginViewModel) without placing too much focus on the platform specific implementation (android Layout axml etc.). Having a separate ViewModel allows us to test the App as we are building it, and if the View changes (i.e. additional ui controls are need) we can add them to the views without overhauling the entire app, (see diagram mvvm). The contents of Core library are described below. 

 
File Structure:

Directories:

References/
Contains references for .Net libraries and the api_interaction_kit library used for Http access and other API specific functions. More on this later.


Packages/ 

This directory contains all the nuget packages that is used in the core library. You will find the mvvmcross core library packages in this directory, as well as other packages used for data storage and network (e.g. HttpClient) communication.

Properties/
This directory contains the assemblyinfo.cs file. This file is automatically generated does not require any modifications.

ToDo-MvvmCross/
This directory is usesless and can be deleted.

ViewModels/
This directory contains all the UI and navigation logic. Contents of ViewModels directory will be responsible for updating the android specific View as well as performing any Network tasks such as login and sync_data operations.

Models/
This directory contains the definitions of all the data that we will be displaying to the user as well as any data we might need to perform certain network task (i.e. Json serializations).
The data is defined in a .cs file as a class having members and properties. Data that is used for specific operations such as Json file deserialization is marked with [JsonProperty] tag to allow for direct serialization of Json Objects.
 


User Interface and Navigation:

Android design is very robust when dealing with UI Navigation. The Navigation Drawer is used in this app as per android design docs. When users want to navigate to a different section of the app, all they are required to do is click the "Hamburger" menu icon and the drawer will appear. Clicking a menu item in the drawer will navigate to the selected pack clicking the menu icon again or anywhere in the app will close the drawer menu.

Please refere to android design documentations for more information about how to implement navigation drawer.
https://developer.android.com/training/implementing-navigation/nav-drawer.html
 

Creating Ireach.Core & ireach.Droid

To get started in creating our core library, we must create a new project using either Xamarin Studio or Visual studio.
For the project type select .Net Portable Class Library if your are using VS2013+, for xamarin pick Library project then select Portable Class Library. Sometimes the Portable class library option is not there, if that is the case then you must make sure that the VisualStudio.Android  has been successfully installed. You make have to download the executable from store or from Visual Studio Gallary website.


// Picture here

Name your i.e. ProjectName.Core and your solution file should be name ProjectName.
Install the MVVMCross Hot Tuna Starter package. As of this writing the current stable release is v3.5.1 

Create an android App and install the hot tuna starter package same as above.

You will notice that new files and directories matching the above directory structure has been created in both the Core and Droid projects. 

Auto Generated Files:

Core Project:
FirstViewModel.cs 

This is the generic view model that will be loaded during appstart when the application first launches. The FirstViewModel is loaded in memory as a singleton instance which means at any given point in time 
There will only be one instance of this view model. This is an equivilent of MasterDetailPage() in other mobile platforms i.e. Windows Phone.

App.cs

The starting point of an MVVMCross android application. This is an implementation of IoC / Service locator pattern.
This class is responsible for creating an instance of the application on start. It will register the FirstViewModel as a Lazy singleton and call the RegisterAppStart<ViewModels.FirstViewModel>();
When custom start is need, such a when we require a login before access to the app the we can call RegisterAppStart (new AppStart()); passing in a new object for the argument.
AppStart is custom class that Inherits from MvxNavigatingObject and implements IMvxAppStart interface like so..
         
public void Start(object hint = null)
{
          ShowViewModel<ViewModels.HomeViewModel>();
}
   

Droid Project

FirstView.axml - Located in Resources/Layout directory. FirstView is an android layout file that represents ViewModel associated with FirstViewModel.cs. The MvvmCross naming conventions has been has been standardized to allow finding related Views and ViewModels easier.

The Layout files / Views define much of the platform specific UI controls for the App. To allow for easy communications between view models and views, mvvmcross provides the ability to bind certain element of the UI directly to properties in the associated ViewModel. Refer to MvvmCross Data Binding for more information.

Example of two way binding:
From ViewModel to properties on the view itself and from the view to the properties in the ViewModel






FirstView.cs  - located in Views/ directory. FirstView.cs is the equivelent of an activity. It implements MvxActivity  and 
Calls OnCreate() similar to an android activity. This File is responsible for displaying the axml UI layout file. 



Implementing the Navigation Drawer

Preparations:
For Ireach.Core there are several ViewModels that must be created. We begin by creating a MainViewModel.cs file
And deleting both FirstViewModel and FirstView from both projects. Below is a sketch of how we will navigate our starting from the MainViewModel.




 diagram MainViewModel linking





ViewModels

	MainViewModel.cs
	
	The MainViewModel class inherits from MvxViewModel and it is the first view model
	That is started when app launches. We could also call other view models from this ViewModel
	(ViewModel to ViewModel navigation) 
	
	





 diagram mvvm
credits Reynolds Mark Xamarin Essentials  



With Async and await


Async methods have three possible return types: Task<TResult>, Task, and void. In Visual Basic, the void return type is written as a Sub procedure.

Microsoft MSDN : https://msdn.microsoft.com/en-us/library/hh524395.aspx#BKMK_TaskTReturnType> 



Task(T) Return Type

used for an async method that contains a Return (Visual Basic) or return (C#) statement in which the operand has typeTResult.


Returning a  Task<int> : 

	• The task must have int return type.
	• Task must call await for actual work to be done 
	





	

	
